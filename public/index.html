<button onclick="logout()" class="btn btn-secondary float-end">Logout</button>
<!DOCTYPE html>
<html>
<head>
    <title>Shop Inventory Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="container mt-4">

<h2 class="mb-4">Shop Inventory Dashboard</h2>

<!-- ADD PRODUCT -->
<div class="card p-3 mb-4">
    <h4>Add Product</h4>
    <input id="name" class="form-control mb-2" placeholder="Product Name">
    <input id="cost" class="form-control mb-2" placeholder="Cost Price" type="number">
    <input id="selling" class="form-control mb-2" placeholder="Selling Price" type="number">
    <input id="quantity" class="form-control mb-2" placeholder="Quantity" type="number">
    <button onclick="addProduct()" class="btn btn-primary">Add Product</button>
</div>

<!-- SELL PRODUCT -->
<div class="card p-3 mb-4">
    <h4>Sell Product</h4>
    <input id="sell_id" class="form-control mb-2" placeholder="Product ID" type="number">
    <input id="sell_qty" class="form-control mb-2" placeholder="Quantity to Sell" type="number">
    <button onclick="sellProduct()" class="btn btn-danger">Sell</button>
</div>

<!-- PURCHASE PRODUCT -->
<div class="card p-3 mb-4">
    <h4>Restock Product</h4>
    <input id="purchase_id" class="form-control mb-2" placeholder="Product ID" type="number">
    <input id="purchase_qty" class="form-control mb-2" placeholder="Quantity to Add" type="number">
    <input id="purchase_cost" class="form-control mb-2" placeholder="New Cost Price" type="number">
    <button onclick="purchaseProduct()" class="btn btn-warning">Add Stock</button>
</div>

<!-- REPORTS -->
<div class="card p-3 mb-4">
    <h4>Reports</h4>
    <button onclick="loadDaily()" class="btn btn-info me-2">Daily</button>
    <button onclick="loadMonthly()" class="btn btn-info me-2">Monthly</button>
    <button onclick="loadYearly()" class="btn btn-info">Yearly</button>

    <div id="reportResult" class="mt-3"></div>
</div>

<!-- MONTHLY CHART -->
<div class="card p-3 mb-4">
    <h4>Monthly Sales Chart</h4>
    <canvas id="salesChart"></canvas>
</div>

<!-- PRODUCT LIST -->
<div class="card p-3 mb-4">
    <h4>Products</h4>
    <button onclick="loadProducts()" class="btn btn-success mb-2">Refresh</button>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Stock</th>
                <th>Cost</th>
                <th>Selling</th>
            </tr>
        </thead>
        <tbody id="productTable"></tbody>
    </table>
</div>

<script>
const API = "http://localhost:5000";

/* ADD PRODUCT */
async function addProduct() {
    const data = {
        name: document.getElementById("name").value,
        cost_price: Number(document.getElementById("cost").value),
        selling_price: Number(document.getElementById("selling").value),
        quantity: Number(document.getElementById("quantity").value)
    };

    await fetch(API + "/products", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    });

    alert("Product Added!");
    loadProducts();
}

/* SELL PRODUCT */
async function sellProduct() {
    const data = {
        product_id: Number(document.getElementById("sell_id").value),
        quantity: Number(document.getElementById("sell_qty").value)
    };

    const res = await fetch(API + "/sales", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    });

    const result = await res.json();
    alert(result.message);
    loadProducts();
    loadChart();
}

/* PURCHASE PRODUCT */
async function purchaseProduct() {
    const data = {
        product_id: Number(document.getElementById("purchase_id").value),
        quantity: Number(document.getElementById("purchase_qty").value),
        cost_price: Number(document.getElementById("purchase_cost").value)
    };

    const res = await fetch(API + "/purchase", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    });

    const result = await res.json();
    alert(result.message);
    loadProducts();
}

/* LOAD PRODUCTS WITH LOW STOCK ALERT + TOTAL VALUE */
async function loadProducts() {
    const res = await fetch(API + "/products");
    const products = await res.json();

    const table = document.getElementById("productTable");
    table.innerHTML = "";

    let totalStockValue = 0;

    products.forEach(p => {

        totalStockValue += p.quantity * p.cost_price;

        const lowStockClass = p.quantity < 10 ? "table-danger" : "";

        table.innerHTML += `
            <tr class="${lowStockClass}">
                <td>${p.id}</td>
                <td>${p.name}</td>
                <td>${p.quantity}</td>
                <td>${p.cost_price}</td>
                <td>${p.selling_price}</td>
            </tr>
        `;
    });

    document.getElementById("reportResult").innerHTML =
        `<strong>Total Stock Value:</strong> ₹${totalStockValue}`;
}

/* REPORTS */
async function loadDaily() {
    const res = await fetch(API + "/reports/daily");
    const data = await res.json();

    document.getElementById("reportResult").innerHTML = `
        <strong>Daily Report:</strong><br>
        Total Sales: ₹${data.total_sales}<br>
        Total Profit: ₹${data.total_profit}
    `;
}

async function loadMonthly() {
    const res = await fetch(API + "/reports/monthly");
    const data = await res.json();

    document.getElementById("reportResult").innerHTML = `
        <strong>Monthly Report:</strong><br>
        Total Sales: ₹${data.total_sales}<br>
        Total Profit: ₹${data.total_profit}
    `;
}

async function loadYearly() {
    const res = await fetch(API + "/reports/yearly");
    const data = await res.json();

    document.getElementById("reportResult").innerHTML = `
        <strong>Yearly Report:</strong><br>
        Total Sales: ₹${data.total_sales}<br>
        Total Profit: ₹${data.total_profit}
    `;
}

/* MONTHLY SALES CHART */
let chart;

async function loadChart() {
    const res = await fetch(API + "/reports/monthly");
    const data = await res.json();

    const ctx = document.getElementById("salesChart");

    if (chart) {
        chart.destroy();
    }

    chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Sales', 'Profit'],
            datasets: [{
                label: 'Monthly Report',
                data: [data.total_sales, data.total_profit]
            }]
        }
    });
}

loadProducts();
loadChart();

async function logout() {
    await fetch("http://localhost:5000/logout");
    window.location.href = "/login.html";
}
</script>

</body>
</html>